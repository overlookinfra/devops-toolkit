version: "1.0"
kind: pipeline
metadata:
  name: devops-toolkit-pr-close
  description: Triggered when a PR is closed
spec:
  triggers:
  - type: git
    provider: github
    context: github
    name: pr-close
    repo: puppetlabs/devops-toolkit
    events:
    - pullrequest.closed
    pullRequestAllowForkEvents: true
    pullRequestTargetBranchRegex: /master/gi
    verified: true
  contexts: []
  stages:
    - deploy
    - cleanup
  steps:
    clone_env_repo:
      title: Cloning preview env. repo
      type: git-clone
      arguments:
        git: github
        repo: puppetlabs/argocd-previews
      stage: deploy
    remove_preview:
      image: 'vfarcic/argocd-pipeline:1.0.ee76b7a'
      title: Removing preview environment app
      working_directory: '${{clone_env_repo}}'
      commands:
        - cf_export APP_ID=pr-$CF_REPO_NAME-$CF_PULL_REQUEST_NUMBER
        - rm -f helm/templates/$APP_ID.yaml
        - git add .
      stage: deploy
    push_env_repo:
      title: Push preview env. changes to the repo
      type: git-commit
      arguments:
        git: github
        repo: puppetlabs/argocd-previews
        commit_message: 'Adding PR ${{CF_PULL_REQUEST_NUMBER}} from ${{CF_REPO_NAME}}'
        git_user_name: '${{CF_COMMIT_AUTHOR}}'
        working_directory: /codefresh/volume/argocd-previews
      stage: deploy
    argocd_sync_and_wait_previews:
      title: Sync ArgoCD previews app-of-apps and wait until healthy
      type: argocd-sync
      arguments:
        context: argocd-gene-test-1
        app_name: previews
        wait_healthy: true
      stage: cleanup
    delete_namespace:
      title: Delete app
      type: helm
      arguments:
        action: auth
        helm_version: 3.2.4
        kube_context: gene-test-1
        namespace: '${{APP_ID}}'
        commands:
          - kubectl delete namespace ${{APP_ID}}
      stage: cleanup

